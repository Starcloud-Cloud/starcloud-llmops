<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.starcloud.ops.business.log.dal.mysql.LogAppConversationMapper">

    <!-- 分页查询会话列表 -->
    <select id="selectSqlPage"
            parameterType="com.starcloud.ops.business.log.api.conversation.vo.LogAppConversationInfoPageReqVO"
            resultType="com.starcloud.ops.business.log.dal.dataobject.LogAppConversationInfoPO">
        SELECT
        t.uid,
        t.app_uid,
        t.app_name,
        t.app_mode,
        t.from_scene,
        t.status,
        t.creator,
        t.end_user,
        t.create_time,
        t.update_time,
        COUNT(t1.id) AS messageCount,
        COUNT(t2.id) AS feedbacksCount,
        SUM(t1.elapsed) AS totalElapsed,
        SUM(t1.total_price) AS totalPrice,
        SUM(t1.message_tokens) AS totalMessageTokens,
        SUM(t1.answer_tokens) AS totalAnswerTokens,
        SUM(t1.message_tokens + t1.answer_tokens) AS tokens
        FROM llm_log_app_conversation t
        LEFT JOIN llm_log_app_message t1 ON (t1.app_conversation_uid = t.uid)
        LEFT JOIN llm_log_app_message_feedbacks t2 ON (t2.app_message_uid = t1.uid)
        <where>
            <if test="appUid != null and appUid != '' ">
                AND t.app_uid = #{appUid}
            </if>
            <if test="appName != null and appName != '' ">
                <bind name="appName" value="appName+'%'"/>
                AND t.app_name LIKE #{appName}
            </if>
            <if test="appMode != null and appMode != '' ">
                AND t.app_mode = #{appMode}
            </if>
            <if test="fromScene != null and fromScene != '' ">
                AND t.from_scene = #{fromScene}
            </if>
            <if test="status != null and status != '' ">
                AND t.status = #{status}
            </if>
            <if test="startTime != null and endTime != null">
                AND t.update_time between #{startTime} and #{endTime}
            </if>
            <if test="type != null and type == 'GENERATE_RECORD' and (appMode == null or appMode == '') and appModeList != null and appModeList.size() > 0">
                AND app_mode IN
                <foreach collection="appModeList" item="appModeItem" open="(" separator="," close=")">
                    #{appModeItem}
                </foreach>
            </if>
        </where>
        GROUP BY t.id
        ORDER BY t.update_time DESC

    </select>


</mapper>