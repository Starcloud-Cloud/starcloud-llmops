<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.starcloud.ops.business.log.dal.mysql.LogAppMessageMapper">

    <!-- 日志统计 -->
    <select id="getAppMessageStatisticsList"
            parameterType="com.starcloud.ops.business.log.api.message.vo.LogAppMessageStatisticsListReqVO"
            resultType="com.starcloud.ops.business.log.dal.dataobject.LogAppMessageStatisticsListPO">
        SELECT
        count(ms.id) as messageCount,
        COUNT(
        CASE
        WHEN ms.status = "SUCCESS"
        THEN
        1
        END
        ) AS successCount,
        COUNT(
        CASE
        WHEN ms.status != "SUCCESS"
        THEN
        1
        END
        ) AS errorCount,
        COUNT(
        CASE
        WHEN fb.rating = "LIKE"
        THEN
        1
        END
        ) as feedbackLikeCount,
        COUNT(DISTINCT(ms.creator)) as userCount,
        SUM(ms.elapsed) as elapsedTotal,
        AVG(ms.elapsed) as elapsedAvg,
        SUM(message_tokens) as messageTokens,
        SUM(answer_tokens) as answerTokens,
        SUM(message_tokens + answer_tokens) as tokens,
        <choose>
            <when test="unit == 'HOURS'">
                date_format(ms.create_time, '%Y-%m-%d %h') as create_date
            </when>
            <when test="unit == 'DAYS'">
                date_format(ms.create_time, '%Y-%m-%d') as create_date
            </when>
            <when test="unit == 'MONTHS'">
                date_format(ms.create_time, '%Y-%m') as create_date
            </when>
            <otherwise>
                date_format(ms.create_time, '%Y-%m-%d') as create_date
            </otherwise>
        </choose>

        FROM llm_log_app_message as ms
        LEFT JOIN llm_log_app_message_feedbacks as fb on fb.app_message_uid = ms.uid
        LEFT JOIN llm_log_app_conversation as co on co.uid = ms.app_conversation_uid
        <where>
            <if test="appUid != null and appUid != '' ">
                AND ms.app_uid = #{appUid}
            </if>
            <if test="appName != null and appName != '' ">
                <bind name="appName" value="appName+'%'"/>
                AND co.app_name LIKE #{appName}
            </if>
            <if test="appMode != null and appMode != '' ">
                AND ms.app_mode = #{appMode}
            </if>
            <if test="fromScene != null and fromScene != '' ">
                AND ms.from_scene = #{fromScene}
            </if>
            <if test="status != null and status != '' ">
                AND ms.status = #{status}
            </if>
            <if test="startTime != null and endTime != null">
                AND ms.create_time between #{startTime} and #{endTime}
            </if>
            <if test="type != null and type == 'GENERATE_RECORD' and (appMode == null or appMode == '') and appModeList != null and appModeList.size() > 0">
                AND app_mode IN
                <foreach collection="appModeList" item="appModeItem" open="(" separator="," close=")">
                    #{appModeItem}
                </foreach>
            </if>
        </where>
        <if test="unit == 'HOURS'">
            GROUP BY date_format(ms.create_time, '%Y-%m-%d %h')
        </if>
        <if test="unit == 'DAYS'">
            GROUP BY date_format(ms.create_time, '%Y-%m-%d')
        </if>
        <if test="unit == 'MONTHS'">
            GROUP BY date_format(ms.create_time, '%Y-%m')
        </if>
        ORDER BY create_date;
    </select>


</mapper>