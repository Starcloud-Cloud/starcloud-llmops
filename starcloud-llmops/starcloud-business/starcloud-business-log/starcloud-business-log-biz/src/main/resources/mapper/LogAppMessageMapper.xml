<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.starcloud.ops.business.log.dal.mysql.LogAppMessageMapper">

    <sql id="listLogMessageStatisticsColumns">
        COUNT(ms.id) AS messageCount,
        COUNT(CASE WHEN ms.status = "SUCCESS" THEN 1 END) AS successCount,
        COUNT(CASE WHEN ms.status != "SUCCESS" THEN 1 END) AS errorCount,
        COUNT(CASE WHEN fb.rating = "LIKE" THEN 1 END) AS feedbackLikeCount,
        COUNT(DISTINCT ms.creator) AS userCount,
        SUM(ms.elapsed) AS elapsedTotal,
        AVG(ms.elapsed) AS elapsedAvg,
        SUM(ms.message_tokens) AS messageTokens,
        SUM(ms.answer_tokens) AS answerTokens,
        SUM(ms.message_tokens + ms.answer_tokens) AS tokens,
        <choose>
            <when test="query.unit == 'HOURS'">
                date_format(ms.create_time, '%Y-%m-%d %h') as create_date
            </when>
            <when test="query.unit == 'DAYS'">
                date_format(ms.create_time, '%Y-%m-%d') as create_date
            </when>
            <when test="query.unit == 'MONTHS'">
                date_format(ms.create_time, '%Y-%m') as create_date
            </when>
            <otherwise>
                date_format(ms.create_time, '%Y-%m-%d') as create_date
            </otherwise>
        </choose>
    </sql>

    <sql id="listLogMessageStatisticsOrderBy">
        <if test="query.unit == 'HOURS'">
            GROUP BY date_format(ms.create_time, '%Y-%m-%d %h')
        </if>
        <if test="query.unit == 'DAYS'">
            GROUP BY date_format(ms.create_time, '%Y-%m-%d')
        </if>
        <if test="query.unit == 'MONTHS'">
            GROUP BY date_format(ms.create_time, '%Y-%m')
        </if>
    </sql>

    <sql id="tempPublishUidCTE">
        WITH temp_publish_uid AS (
            SELECT
                market_uid
            FROM llm_log_app_publish
            WHERE
                app_uid = #{appUid}
            AND uid = (COALESCE(SUBSTRING_INDEX((SELECT publish_uid FROM llm_app WHERE uid = #{appUid}), '-', 1), ''))
        )
    </sql>

    <!-- 生成记录日志统计 -->
    <select id="listLogMessageStatistics"
            resultType="com.starcloud.ops.business.log.dal.dataobject.LogAppMessageStatisticsListPO">
        SELECT
        <include refid="listLogMessageStatisticsColumns"/>
        FROM llm_log_app_message as ms
        LEFT JOIN llm_log_app_message_feedbacks as fb on fb.app_message_uid = ms.uid
        LEFT JOIN llm_log_app_conversation as co on co.uid = ms.app_conversation_uid
        <where>
            <if test="query.appUid != null and query.appUid != '' ">
                AND ms.app_uid = #{query.appUid}
            </if>
            <if test="query.appName != null and query.appName != '' ">
                <bind name="appName" value="query.appName+'%'"/>
                AND co.app_name LIKE #{appName}
            </if>
            <if test="query.appMode != null and query.appMode != '' ">
                AND ms.app_mode = #{query.appMode}
            </if>
            <if test="query.fromScene != null and query.fromScene != '' ">
                AND ms.from_scene = #{query.fromScene}
            </if>
            <if test="query.status != null and query.status != '' ">
                AND ms.status = #{query.status}
            </if>
            <if test="query.startTime != null and query.endTime != null">
                AND ms.create_time between #{query.startTime} and #{query.endTime}
            </if>
            <if test="query.type != null and query.type == 'GENERATE_RECORD' and (query.fromScene == null or query.fromScene == '') and query.fromSceneList != null and query.fromSceneList.size() > 0">
                AND ms.from_scene IN
                <foreach collection="query.fromSceneList" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        <include refid="listLogMessageStatisticsOrderBy"/>
        ORDER BY create_date;
    </select>

    <!-- 根据应用 UID 日志统计 -->
    <select id="listLogMessageStatisticsByAppUid"
            resultType="com.starcloud.ops.business.log.dal.dataobject.LogAppMessageStatisticsListPO">

        SELECT
        <include refid="listLogMessageStatisticsColumns"/>
        FROM llm_log_app_message as ms
        LEFT JOIN llm_log_app_message_feedbacks as fb on fb.app_message_uid = ms.uid
        LEFT JOIN llm_log_app_conversation as co on co.uid = ms.app_conversation_uid
        <where>
            <if test="query.appUid != null and query.appUid != '' ">
                AND ms.app_uid = #{query.appUid}
            </if>
            <if test="query.fromScene != null and query.fromScene != '' ">
                AND ms.from_scene = #{query.fromScene}
            </if>
            <if test="query.status != null and query.status != '' ">
                AND ms.status = #{query.status}
            </if>
            <if test="query.startTime != null and query.endTime != null">
                AND ms.create_time between #{query.startTime} and #{query.endTime}
            </if>
        </where>
        <include refid="listLogMessageStatisticsOrderBy"/>
        ORDER BY create_date;
    </select>


</mapper>